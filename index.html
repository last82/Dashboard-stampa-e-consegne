// Componenti e funzioni principali
// Migliorie: gestione stato modale, update ottimistico, separazione in componenti
// N.B.: Non correggo qui la questione sicurezza API (punto 1), solo 2-3-4 come richiesto.

import React, { useState, useEffect, useCallback } from 'react';

// API helpers (puoi poi spostarli in un file separato)
const fetchAirtableData = async (baseId, table, token) => {
  const response = await fetch(`https://api.airtable.com/v0/${baseId}/${table}`, {
    headers: {
      'Authorization': `Bearer ${token}`,
      'Content-Type': 'application/json'
    }
  });
  const data = await response.json();
  return data.records || [];
};

const updateAirtableRecord = async (baseId, table, token, recordId, fields) => {
  const response = await fetch(`https://api.airtable.com/v0/${baseId}/${table}/${recordId}`, {
    method: 'PATCH',
    headers: {
      'Authorization': `Bearer ${token}`,
      'Content-Type': 'application/json'
    },
    body: JSON.stringify({ fields })
  });
  return await response.json();
};

// Modale controllata via React state
function ModaleDettaglio({ open, lavoro, onSave, onClose }) {
  const [path, setPath] = useState(lavoro?.PathFileCAD || '');
  const [note, setNote] = useState(lavoro?.NoteStampa || '');

  useEffect(() => {
    setPath(lavoro?.PathFileCAD || '');
    setNote(lavoro?.NoteStampa || '');
  }, [lavoro]);

  if (!open || !lavoro) return null;

  return (
    <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
      <div className="bg-white rounded-lg p-6 max-w-md w-full mx-4">
        <h3 className="text-lg font-bold mb-4">Dettagli Lavoro {lavoro.CodicePaziente}</h3>
        <div className="mb-4">
          <label className="block text-sm font-medium mb-2">Path File CAD:</label>
          <input 
            type="text"
            value={path}
            onChange={e => setPath(e.target.value)}
            className="w-full border rounded px-3 py-2"
            placeholder="/nas/lavori/..."
          />
        </div>
        <div className="mb-4">
          <label className="block text-sm font-medium mb-2">Note Stampa:</label>
          <textarea 
            value={note}
            onChange={e => setNote(e.target.value)}
            className="w-full border rounded px-3 py-2 h-24"
            placeholder="Materiale, impostazioni, note..."
          />
        </div>
        <div className="flex justify-end space-x-2">
          <button 
            onClick={onClose}
            className="px-4 py-2 border rounded hover:bg-gray-50"
          >Annulla</button>
          <button 
            onClick={() => onSave({ PathFileCAD: path, NoteStampa: note })}
            className="px-4 py-2 bg-blue-500 text-white rounded hover:bg-blue-600"
          >Salva</button>
        </div>
      </div>
    </div>
  );
}

// Card lavoro - estratta come componente
function CardLavoro({ lavoro, steps, daysUntil, onStepClick, onStatusChange, onOpenModal }) {
  // ... Logica visuale simile all'originale, omessa qui per brevit√† ...
  return (
    <div className="bg-white rounded-lg shadow-sm p-4 border-l-4 border-blue-500 card-hover">
      {/* ...intestazione... */}
      <div className="flex justify-between items-center">
        {/* ...select e pulsanti... */}
        <button onClick={onOpenModal} className="bg-blue-500 hover:bg-blue-600 text-white px-3 py-1 rounded text-xs">
          <i className="fas fa-edit mr-1"></i>Dettagli
        </button>
      </div>
    </div>
  );
}

// Dashboard semplificata (solo parte gestione stato/modale/update)
function Dashboard() {
  // Config: importala da env o costanti
  const AIRTABLE_BASE_ID = '...';
  const AIRTABLE_TOKEN = '...';
  const TIMELINE_TABLE = '...';
  const PRESCRIZIONI_TABLE = '...';

  const [lavori, setLavori] = useState([]);
  const [loading, setLoading] = useState(true);
  const [selectedLavoro, setSelectedLavoro] = useState(null);
  const [showModal, setShowModal] = useState(false);

  const loadData = useCallback(async () => {
    setLoading(true);
    const timelineData = await fetchAirtableData(AIRTABLE_BASE_ID, TIMELINE_TABLE, AIRTABLE_TOKEN);
    // ...unisci dati prescrizioni...
    setLavori(timelineData.map(record => ({
      // ...mapping...
      id: record.id,
      CodicePaziente: record.fields.CodicePaziente,
      PathFileCAD: record.fields.PathFileCAD,
      NoteStampa: record.fields.NoteStampa,
      // ...altro...
    })));
    setLoading(false);
  }, [AIRTABLE_BASE_ID, TIMELINE_TABLE, AIRTABLE_TOKEN]);

  useEffect(() => { loadData(); }, [loadData]);

  // Update ottimistico locale + patch
  const handleSaveModal = async (updateFields) => {
    if (!selectedLavoro) return;
    setShowModal(false);
    setLavori(prev => prev.map(l =>
      l.id === selectedLavoro.id ? { ...l, ...updateFields } : l
    ));
    try {
      await updateAirtableRecord(
        AIRTABLE_BASE_ID,
        TIMELINE_TABLE,
        AIRTABLE_TOKEN,
        selectedLavoro.id,
        updateFields
      );
    } catch (e) {
      // rollback se errore
      await loadData();
      alert('Errore nel salvataggio');
    }
  };

  return (
    <div className="min-h-screen bg-gray-50">
      {/* ...header... */}
      <div className="space-y-3">
        {lavori.map(lavoro => (
          <CardLavoro
            key={lavoro.id}
            lavoro={lavoro}
            steps={{}} // ...passa steps se serve...
            daysUntil={null} // ...calcola giorni...
            onStepClick={() => {}}
            onStatusChange={() => {}}
            onOpenModal={() => {
              setSelectedLavoro(lavoro);
              setShowModal(true);
            }}
          />
        ))}
      </div>
      <ModaleDettaglio
        open={showModal}
        lavoro={selectedLavoro}
        onSave={handleSaveModal}
        onClose={() => setShowModal(false)}
      />
    </div>
  );
}

// Export Dashboard per React app
export default Dashboard;

